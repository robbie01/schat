<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <meta name="format-detection" content="telephone=no">
        <title>SChat</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <link href="/static/chat.css" rel="stylesheet">
    </head>
    <body>
        <div id="channels" hx-target="#chat">
            <a>general</a>
            <a href="/chat/abc/">abc</a>
        </div>
        <div id="chat" hx-ext="ws" ws-connect="ws">
            <ul id="messages" th:attrappend="hx-swap-oob=${liveUpdate}?'beforeend'">
                <li th:each="message: ${messages}" th:attr="data-id=${message.id}">
                    <strong th:text="${message.username}">robbie</strong>: <span th:text="${message.msg}">hello world</span>
                </li>
            </ul>
            <form id="send" hx-post="" hx-on::before-request="this.reset()">
                <input type="text" name="msg" placeholder="Message...">
                <input type="submit" value="âž¤">
            </form>
        </div>
        <script>
            {
                let chat = document.getElementById("chat")
                let messages = document.getElementById("messages")

                chat.addEventListener("htmx:wsOpen", e => {
                    let after = messages.lastElementChild?.dataset?.id ?? -1;
                    e.detail.socketWrapper.sendImmediately(
                        JSON.stringify({ after }),
                        messages
                    )
                })

                window.addEventListener("DOMContentLoaded", () => {
                    messages.scrollTo(0, messages.scrollHeight)
                })

                chat.addEventListener("htmx:wsAfterMessage", () => {
                    messages.scrollTo(0, messages.scrollHeight)
                })
            }
        </script>
        <script src="/static/htmx.js"></script>
        <script src="/static/htmx-ext-ws.js"></script>
    </body>
</html>